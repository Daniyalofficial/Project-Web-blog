{% extends "base.html" %}

{% block title %}{{ post.meta_title or post.title }} - Gztechiz{% endblock %}

{% block meta_description %}{{ post.meta_description or post.excerpt }}{% endblock %}
{% block meta_keywords %}{{ post.meta_keywords }}{% endblock %}

{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{{ post.meta_description or post.excerpt }}{% endblock %}
{% block og_image %}{% if post.og_image %}{{ url_for('static', filename='uploads/' + post.og_image) }}{% elif post.image
%}{{ url_for('static', filename='uploads/' + post.image) }}{% else %}{{ url_for('static',
filename='images/og-image.jpg') }}{% endif %}{% endblock %}

{% block twitter_title %}{{ post.title }}{% endblock %}
{% block twitter_description %}{{ post.meta_description or post.excerpt }}{% endblock %}
{% block twitter_image %}{% if post.og_image %}{{ url_for('static', filename='uploads/' + post.og_image) }}{% elif
post.image %}{{ url_for('static', filename='uploads/' + post.image) }}{% else %}{{ url_for('static',
filename='images/twitter-image.jpg') }}{% endif %}{% endblock %}

{% block content %}
<article class="blog-single">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="{{ url_for('home') }}">Home</a> &gt;
        <a href="{{ url_for('blog_list') }}">Blog</a> &gt;
        {% if post.category %}
        <a href="{{ url_for('category_view', slug=post.category.slug) }}">{{ post.category.name }}</a> &gt;
        {% endif %}
        <span>{{ post.title|truncate(30) }}</span>
    </nav>

    <!-- Featured Image -->
    {% if post.image %}
    <img src="{{ url_for('static', filename='uploads/' + post.image) }}" alt="{{ post.title }}"
        class="blog-featured-image" loading="eager">
    {% endif %}

    <!-- Title -->
    <h1 class="blog-title">{{ post.title }}</h1>

    <!-- Subtitle -->
    {% if post.subtitle %}
    <h2 class="blog-subtitle">{{ post.subtitle }}</h2>
    {% endif %}

    <!-- Meta Information -->
    <div class="blog-meta">
        <div class="blog-meta-item">
            <i class="fas fa-user"></i> {{ post.author }}
        </div>
        <div class="blog-meta-item">
            <i class="fas fa-clock"></i> {{ post.readtime }}
        </div>
        <div class="blog-meta-item">
            <i class="fas fa-calendar"></i> {{ post.created_at.strftime('%B %d, %Y') }}
        </div>
        {% if post.category %}
        <div class="blog-meta-item">
            <i class="fas fa-folder"></i>
            <a href="{{ url_for('category_view', slug=post.category.slug) }}">{{ post.category.name }}</a>
        </div>
        {% endif %}
        <div class="blog-meta-item">
            <i class="fas fa-eye"></i> {{ post.views }} views
        </div>
    </div>

    <!-- Social Share Buttons -->
    <div class="social-share">
        <span class="share-label">Share:</span>
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url|urlencode }}" class="share-btn facebook"
            target="_blank" rel="noopener">
            <i class="fab fa-facebook-f"></i> Facebook
        </a>
        <a href="https://twitter.com/intent/tweet?text={{ post.title|urlencode }}&url={{ request.url|urlencode }}"
            class="share-btn twitter" target="_blank" rel="noopener">
            <i class="fab fa-twitter"></i> Twitter
        </a>
        <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.url|urlencode }}&title={{ post.title|urlencode }}"
            class="share-btn linkedin" target="_blank" rel="noopener">
            <i class="fab fa-linkedin-in"></i> LinkedIn
        </a>
        <a href="https://wa.me/?text={{ post.title|urlencode }}%20{{ request.url|urlencode }}"
            class="share-btn whatsapp" target="_blank" rel="noopener">
            <i class="fab fa-whatsapp"></i> WhatsApp
        </a>
        <a href="https://t.me/share/url?url={{ request.url|urlencode }}&text={{ post.title|urlencode }}"
            class="share-btn telegram" target="_blank" rel="noopener">
            <i class="fab fa-telegram"></i> Telegram
        </a>
        <button onclick="copyToClipboard('{{ request.url }}')" class="share-btn copy-link">
            <i class="fas fa-link"></i> Copy Link
        </button>
    </div>

    <!-- Content -->
    <div class="blog-content">
        {{ post.content|safe }}
    </div>

    <!-- Tags (if any) -->
    {% if post.meta_keywords %}
    <div class="blog-tags">
        <strong>Tags:</strong>
        {% for tag in post.meta_keywords.split(',') %}
        <span class="blog-tag">{{ tag.strip() }}</span>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Admin Actions -->
    {% if session.get('admin') %}
    <div class="admin-actions">
        <a href="{{ url_for('edit_blog', id=post.id) }}" class="btn btn-secondary">
            <i class="fas fa-edit"></i> Edit Post
        </a>
        <a href="{{ url_for('delete_blog', id=post.id) }}" class="btn btn-danger"
            onclick="return confirm('Are you sure you want to delete this post?')">
            <i class="fas fa-trash"></i> Delete Post
        </a>
    </div>
    {% endif %}

    <!-- Navigation Between Posts -->
    <div class="post-navigation">
        <div class="nav-previous">
            {% if prev_post %}
            <a href="{{ url_for('post', slug=prev_post.slug) }}" class="nav-link">
                <i class="fas fa-chevron-left"></i> Previous
                <span class="nav-title">{{ prev_post.title|truncate(40) }}</span>
            </a>
            {% endif %}
        </div>
        <div class="nav-next">
            {% if next_post %}
            <a href="{{ url_for('post', slug=next_post.slug) }}" class="nav-link">
                Next <i class="fas fa-chevron-right"></i>
                <span class="nav-title">{{ next_post.title|truncate(40) }}</span>
            </a>
            {% endif %}
        </div>
    </div>
</article>

<!-- Comments Section -->
<section class="comments-section">
    <h2 class="comments-header">
        <i class="fas fa-comments"></i>
        Comments
        <span class="comments-count">{{ comments|length }}</span>
    </h2>

    <!-- Comment Form -->
    <div class="comment-form">
        <h3>Add a Comment</h3>
        <form method="POST" id="commentForm" novalidate>
            <input type="hidden" name="parent_id" id="parent_id" value="">

            <div class="form-row">
                <div class="form-group">
                    <label for="name" class="form-label">Name *</label>
                    <input type="text" id="name" name="name" class="form-control" placeholder="Your name" required
                        maxlength="50">
                </div>
                <div class="form-group">
                    <label for="email" class="form-label">Email *</label>
                    <input type="email" id="email" name="email" class="form-control" placeholder="Your email" required
                        maxlength="120">
                </div>
            </div>

            <div class="form-group">
                <label for="text" class="form-label">Comment *</label>
                <textarea id="text" name="text" class="form-control" rows="4" placeholder="Write your comment..."
                    required maxlength="1000"></textarea>
                <small class="form-help">Max 1000 characters</small>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Post Comment
            </button>
        </form>
    </div>

    <!-- Comments List -->
    <div class="comments-list">
        {% for comment in comments %}
        <div class="comment" data-id="{{ comment.id }}">
            <div class="comment-header">
                <div class="comment-avatar">
                    {{ comment.name[:1]|upper }}
                </div>
                <div class="comment-info">
                    <strong class="comment-author">{{ comment.name }}</strong>
                    <span class="comment-time">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                </div>
            </div>
            <div class="comment-content">
                {{ comment.text|safe }}
            </div>
            <button class="comment-reply btn btn-sm btn-secondary" data-comment-id="{{ comment.id }}"
                data-author-name="{{ comment.name }}">
                <i class="fas fa-reply"></i> Reply
            </button>
            <!-- Replies -->
            {% if comment.children %}
            <div class="comment-replies">
                {% for reply in comment.children %}
                <div class="comment reply" data-id="{{ reply.id }}">
                    <div class="comment-header">
                        <div class="comment-avatar">
                            {{ reply.name[:1]|upper }}
                        </div>
                        <div class="comment-info">
                            <strong class="comment-author">{{ reply.name }}</strong>
                            <span class="comment-time">{{ reply.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                        </div>
                    </div>
                    <div class="comment-content">
                        {{ reply.text|safe }}
                    </div>
                    <button class="comment-reply btn btn-sm btn-secondary" data-comment-id="{{ comment.id }}"
                        data-author-name="{{ comment.name }}">
                        <i class="fas fa-reply"></i> Reply
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}

        {% if not comments %}
        <div class="no-comments">
            <p>No comments yet. Be the first to comment!</p>
        </div>
        {% endif %}
    </div>
</section>

<div class="text-center mt-4">
    <a href="{{ url_for('blog_list') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Blog
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Social Sharing Functions
    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            showToast('Link copied to clipboard!', 'success');
        } catch (err) {
            console.error('Failed to copy:', err);
            showToast('Failed to copy link', 'error');
        }
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>
            <span>${message}</span>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) toast.remove();
        }, 3000);
    }

    // Reply to comment - FIXED VERSION
    function replyToComment(commentId, authorName) {
        console.log('Replying to comment ID:', commentId, 'by:', authorName);

        // Set parent comment ID in hidden field
        const parentIdField = document.getElementById('parent_id');
        if (parentIdField) {
            parentIdField.value = commentId;
        }

        // Focus on comment textarea and add @mention
        const textarea = document.getElementById('text');
        if (textarea) {
            let currentValue = textarea.value;
            if (!currentValue.includes('@' + authorName)) {
                textarea.value = `@${authorName} ` + currentValue;
            }

            textarea.focus();
            textarea.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        // Update form title
        const formTitle = document.querySelector('.comment-form h3');
        if (formTitle) {
            formTitle.textContent = `Replying to ${authorName}`;
            formTitle.style.color = '#3b82f6';
        }

        // Show success toast
        showToast(`Replying to ${authorName}`, 'info');
    }

    // Reset reply function
    function resetReply() {
        const parentIdField = document.getElementById('parent_id');
        if (parentIdField) {
            parentIdField.value = '';
        }

        const formTitle = document.querySelector('.comment-form h3');
        if (formTitle) {
            formTitle.textContent = 'Add a Comment';
            formTitle.style.color = '';
        }
    }

    // Auto-reset when clicking in textarea if it's empty
    document.addEventListener('DOMContentLoaded', function () {
        const textarea = document.getElementById('text');
        if (textarea) {
            textarea.addEventListener('click', function () {
                const parentIdField = document.getElementById('parent_id');
                if (parentIdField && parentIdField.value && this.value.trim() === '') {
                    if (confirm('Cancel reply and start new comment?')) {
                        resetReply();
                    }
                }
            });
        }

        // Form validation
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            commentForm.addEventListener('submit', function (e) {
                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim();
                const text = document.getElementById('text').value.trim();

                if (!name || !email || !text) {
                    e.preventDefault();
                    showToast('Please fill in all required fields', 'error');
                    return false;
                }

                // Simple email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    e.preventDefault();
                    showToast('Please enter a valid email address', 'error');
                    return false;
                }

                return true;
            });
        }
    });
</script>
{% endblock %}